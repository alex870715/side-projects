<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API連線測試工具</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a67d8;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .success { border-left-color: #27ae60; }
        .error { border-left-color: #e74c3c; }
        .warning { border-left-color: #f39c12; }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.loading { background: #cce7ff; color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 台股API連線測試工具</h1>
            <p>診斷API連線狀況，找出為什麼顯示模擬資料</p>
        </div>

        <div class="test-section">
            <h3>📊 API狀態檢查</h3>
            <button class="test-button" onclick="testAllAPIs()">🔄 測試所有API</button>
            <button class="test-button" onclick="testTwelveData()">📈 TwelveData API</button>
            <button class="test-button" onclick="testFinanceAPI()">💰 Finance API</button>
            <button class="test-button" onclick="testYahooProxy()">🌐 Yahoo代理</button>
            <button class="test-button" onclick="clearResults()">🧹 清除結果</button>
            <div id="api-results"></div>
        </div>

        <div class="test-section">
            <h3>🔧 系統診斷</h3>
            <button class="test-button" onclick="checkSystemStatus()">🖥️ 系統狀態</button>
            <button class="test-button" onclick="checkNetworkStatus()">🌐 網路狀態</button>
            <button class="test-button" onclick="testCORSSupport()">🔒 CORS支援</button>
            <div id="system-results"></div>
        </div>

        <div class="test-section">
            <h3>⚡ 快速修復</h3>
            <button class="test-button" onclick="showAPIKeyInstructions()">🔑 API Key設定</button>
            <button class="test-button" onclick="switchToProxy()">🔄 切換代理模式</button>
            <button class="test-button" onclick="enableSmartSimulation()">🤖 智能模擬模式</button>
            <div id="fix-results"></div>
        </div>
    </div>

    <script src="real-api-client.js"></script>
    <script>
        let apiClient = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (typeof DirectStockAPIClient !== 'undefined') {
                    apiClient = new DirectStockAPIClient();
                    addResult('system-results', '✅ DirectStockAPIClient 載入成功', 'success');
                } else {
                    addResult('system-results', '❌ DirectStockAPIClient 載入失敗', 'error');
                }
            } catch (error) {
                addResult('system-results', `❌ 初始化錯誤: ${error.message}`, 'error');
            }
        });

        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            container.appendChild(result);
            container.scrollTop = container.scrollHeight;
        }

        async function testAllAPIs() {
            addResult('api-results', '🔄 開始測試所有API...', 'loading');
            
            await testTwelveData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testFinanceAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testYahooProxy();
            
            addResult('api-results', '✅ 所有API測試完成', 'success');
        }

        async function testTwelveData() {
            addResult('api-results', '📈 測試 TwelveData API...', 'loading');
            
            try {
                const url = 'https://api.twelvedata.com/time_series?symbol=2330.TPE&interval=1day&outputsize=5&apikey=demo';
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 0) {
                    addResult('api-results', `✅ TwelveData: 成功獲取資料 (${data.values.length}筆)`, 'success');
                } else if (data.message && data.message.includes('limit')) {
                    addResult('api-results', '⚠️ TwelveData: API呼叫限制已達上限', 'warning');
                } else {
                    addResult('api-results', `❌ TwelveData: ${data.message || '無有效資料'}`, 'error');
                }
            } catch (error) {
                addResult('api-results', `❌ TwelveData: 連線失敗 - ${error.message}`, 'error');
            }
        }

        async function testFinanceAPI() {
            addResult('api-results', '💰 測試 Financial Modeling Prep API...', 'loading');
            
            try {
                const url = 'https://financialmodelingprep.com/api/v3/quote/2330.TPE?apikey=demo';
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.length > 0 && data[0].price) {
                    addResult('api-results', `✅ Finance API: 成功獲取資料 (價格: $${data[0].price})`, 'success');
                } else if (data.error && data.error.includes('limit')) {
                    addResult('api-results', '⚠️ Finance API: API呼叫限制已達上限', 'warning');
                } else {
                    addResult('api-results', `❌ Finance API: ${data.error || '無有效資料'}`, 'error');
                }
            } catch (error) {
                addResult('api-results', `❌ Finance API: 連線失敗 - ${error.message}`, 'error');
            }
        }

        async function testYahooProxy() {
            addResult('api-results', '🌐 測試 Yahoo Finance 代理...', 'loading');
            
            const proxyUrls = [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?'
            ];

            for (const proxy of proxyUrls) {
                try {
                    const targetUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/2330.TW';
                    const response = await fetch(proxy + encodeURIComponent(targetUrl));
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.chart && data.chart.result) {
                            addResult('api-results', `✅ Yahoo (${proxy}): 成功獲取資料`, 'success');
                            return;
                        }
                    }
                } catch (error) {
                    addResult('api-results', `❌ Yahoo (${proxy}): ${error.message}`, 'error');
                }
            }
            
            addResult('api-results', '❌ Yahoo Finance: 所有代理都失敗', 'error');
        }

        function checkSystemStatus() {
            addResult('system-results', '🖥️ 檢查系統狀態...', 'loading');
            
            // 檢查各種系統組件
            const checks = [
                { name: 'DirectStockAPIClient', condition: typeof DirectStockAPIClient !== 'undefined' },
                { name: 'Fetch API', condition: typeof fetch !== 'undefined' },
                { name: 'Promise', condition: typeof Promise !== 'undefined' },
                { name: 'JSON', condition: typeof JSON !== 'undefined' },
                { name: 'Local Storage', condition: typeof localStorage !== 'undefined' }
            ];
            
            checks.forEach(check => {
                const status = check.condition ? '✅' : '❌';
                const type = check.condition ? 'success' : 'error';
                addResult('system-results', `${status} ${check.name}: ${check.condition ? '可用' : '不可用'}`, type);
            });
        }

        async function checkNetworkStatus() {
            addResult('system-results', '🌐 檢查網路狀態...', 'loading');
            
            try {
                const response = await fetch('https://httpbin.org/get');
                if (response.ok) {
                    addResult('system-results', '✅ 網路連線正常', 'success');
                } else {
                    addResult('system-results', '⚠️ 網路連線異常', 'warning');
                }
            } catch (error) {
                addResult('system-results', `❌ 網路連線失敗: ${error.message}`, 'error');
            }
        }

        async function testCORSSupport() {
            addResult('system-results', '🔒 測試CORS支援...', 'loading');
            
            try {
                const response = await fetch('https://api.github.com/users/github');
                if (response.ok) {
                    addResult('system-results', '✅ CORS請求支援正常', 'success');
                } else {
                    addResult('system-results', '⚠️ CORS請求部分限制', 'warning');
                }
            } catch (error) {
                addResult('system-results', `❌ CORS請求被阻擋: ${error.message}`, 'error');
            }
        }

        function showAPIKeyInstructions() {
            const instructions = `
🔑 API Key 設定指南：

1. 申請 TwelveData API Key：
   - 前往 https://twelvedata.com/
   - 註冊免費帳號
   - 獲取 API Key

2. 更新程式碼：
   - 編輯 real-api-client.js
   - 找到第56行左右
   - 將 'demo' 替換為您的 API Key

3. 重新載入頁面測試

建議申請多個API Key輪替使用：
- TwelveData: 每日800次
- Financial Modeling Prep: 每日250次
- Alpha Vantage: 每日500次
            `;
            addResult('fix-results', instructions, 'info');
        }

        function switchToProxy() {
            const instructions = `
🔄 切換到代理模式：

1. 啟動本地代理伺服器：
   npm start

2. 開啟代理模式網址：
   http://localhost:3001/index.html

3. 代理伺服器的優點：
   - 繞過CORS限制
   - 更穩定的API呼叫
   - 統一的錯誤處理

注意：需要Node.js環境
            `;
            addResult('fix-results', instructions, 'info');
        }

        function enableSmartSimulation() {
            const info = `
🤖 智能模擬模式說明：

當前使用的智能模擬資料特色：
- 基於真實股票基準價格
- 考慮市場開盤時間影響
- 模擬真實的價格波動
- 生成合理的成交量
- 所有技術指標計算完全準確

雖然不是即時真實資料，但：
- 學習技術分析完全可行
- 測試投資策略有效
- 了解圖表操作無問題
- AI分析邏輯完全相同

建議：申請免費API Key獲得真實資料
            `;
            addResult('fix-results', info, 'info');
        }

        function clearResults() {
            document.getElementById('api-results').innerHTML = '';
            document.getElementById('system-results').innerHTML = '';
            document.getElementById('fix-results').innerHTML = '';
        }
    </script>
</body>
</html>
